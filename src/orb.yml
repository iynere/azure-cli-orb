version: 2.1
description: |
  Installs the Azure Command Line Interface (azcli)

  The executors within this Orb provide run-time environments that contain the
  necessary dependencies for executing the jobs and commands in this orb,
  except for the following required dependencies that must be configured in
  CircleCI in order to use this orb - environment variables for Azure 
  initialization (TODO).

  The source for this Orb can be found here:
  https://github.com/CircleCI-Public/circleci-orbs/tree/master/src/azure-cli

examples:
  simple_install_and_configure:
    description: Install the azure CLI, if not available
    usage:
      version: 2.1

      orbs:
        azure-cli: circleci/azure-cli@1.0.0

      workflows:
        install_and_configure_cli:
          # optionally determine executor to use
          executor: default
          jobs:
            - azure-cli/install_and_configure_cli:
                context: myContext # your context containing gcloud service key
                google-project-id: myGoogleProjectId
                google-compute-zone: myGoogleComputeZone

executors:
  default:
    description: A debian based docker container to use when running the
                 Azure CLI
    parameters:
      python-version:
        type: string
        default: "2.7"
      debian-release:
        type: string
        default: "stretch"
    docker:
      - image: circleci/python:<< parameters.python-version >>-<< parameters.debian-release >>
  azure:
    description: The official Microsoft docker container with Azure CLI 
                 pre-installed
    docker:
      - image: microsoft/azure-cli

commands:
  install:
    description: |
      Install the Azure CLI, if not available
    steps:
      - run:
          name: Install Azure CLI, if not available
          command: |
            # Set sudo to work whether logged in as root user or non-root user
            if [[ $EUID == 0 ]]; then export SUDO=""; else export SUDO="sudo"; fi

            if [[ $(command -v lsb_release) == "" ]]; then
              $SUDO apt-get update && $SUDO apt-get -y install lsb-release
            fi

            # Create an environment variable for the correct distribution
            export AZ_REPO=$(lsb_release -cs)

            # Modify your sources list 
            echo "deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ $AZ_REPO main" | \
            $SUDO tee /etc/apt/sources.list.d/azure-cli.list

            if [[ $(command -v curl) == "" ]]; then
              $SUDO apt-get update && $SUDO apt-get -y install curl
            fi

            # Get the Microsoft signing key 
            curl -L https://packages.microsoft.com/keys/microsoft.asc | $SUDO apt-key add -

            # Update and install the Azure CLI
            if [[ $(command -v az) == "" ]]; then
              $SUDO apt-get update
              $SUDO apt-get -y install apt-transport-https azure-cli
              echo "Azure CLI is now installed."
            else
              echo "Azure CLI is already installed."
            fi
  login-username:
    description: Initilize the Azure CLI
    parameters:
      azure-username:
        description: Azure account username
        type: string
        default: $AZURE_USERNAME
      azure-password:
        description: Azure account password
        type: string
        default: $AZURE_PASSWORD
    steps:
      - run:
          name: Login to the Azure CLI with a username and password
          command: |
              az login \
              -u <<parameters.azure-username>> \
              -p <<parameters.azure-password>>
